---
layout: post
title: A mime is a terrible thing to waste
---

<div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>One of the first projects I am working on here at ThinkShout requires full-text search of file attachments. This is accomplished using the <a href="http://drupal.org/project/apachesolr_attachments">Apache Solr Attachments</a> module. We're also using the <a href="http://drupal.org/project/facetapi">Facet API</a> module to allow the users to filter their searches based on certain criteria or "facets".  The Facet API module provides several useful facets out-of-the-box, such as a filter by Author and by Content Type. One facet that we wanted to enable for the client's users is the ability to filter on the type of file(s) attached to a node. The Facet API module allows a developer to create filter blocks based on fields indexed by <a href="http://drupal.org/project/apachesolr">Apache Solr Search Integration</a> (or in this case using Acquia Search with <a href="http://drupal.org/project/acquia_connector">Acquia Network Connector</a>).  The Apache Solr Attachments module provides the mimetype of the attached file as a piece of indexed data. Creating a facet is implemented with hook&#95;facetapi&#95;facet&#95;info. Following the examples implemented for the default facets that ship with the module, a facet for mime type can be created by searching on the ss_filemime index field.</p>

<pre><code>function MYMODULE_facetapi_facet_info($searcher_info) {
  $facets = array();

  $facets['mime'] = array(
     'label' =&gt; t('Mime Type'),
     'description' =&gt; t('Filter by mime type.'),
     //indexed field from solr 
     'field' =&gt; 'ss_filemime',
     'map callback' =&gt; 'MYMODULE_map_mime',
     'facet mincount allowed' =&gt; TRUE,
     'dependency plugins' =&gt; array('bundle', 'role'),
   );

  return $facets;
}
</code></pre>

<p>This can be done for any indexed field. Once the facet is implemented it can then be enabled through the admin screen for facets, which then, in turn, provides a block for that facet. The only issue we then faced was translating the presented mime types in a human-readable format. This is done with the map callback. The map callback is a function that takes the values of the index field that can then be associated with other content. In the case of the default Author facet the uid of the content is returned. The map callback for that facet is associated with the Drupal user and returns the username. For file mime types, a simple array of mime type to readable file type was used, so that, for example, "application/vnd.ms-excel" is just returned as "Excel".</p>

<pre><code>function MYMODULE_map_mime(array $values) {
  $map = $values;
  $mimes = array(
    'application/pdf'=&gt;'PDF',
    'application/msword'=&gt;'Word Document',
    'application/vnd.ms-excel'=&gt;'Excel',
  );
  $map = array();
  foreach ($mimes  as $type =&gt; $name) {
    $map[$type] = $name;
  }
  return $map;
}
</code></pre>
</div></div></div><div class="field field-name-taxonomy-vocabulary-1 field-type-taxonomy-term-reference field-label-above"><div class="field-label">Tags:&nbsp;</div><div class="field-items"><div class="field-item even"><a href="/blog/category/drupal-planet" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Drupal Planet</a></div><div class="field-item odd"><a href="/blog/category/apache-solr" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Apache Solr</a></div><div class="field-item even"><a href="/blog/category/facet-api" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Facet API</a></div></div></div>
