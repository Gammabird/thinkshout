---
layout: post
title: Under the Hood of RedHen CRM
---

<div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p><em>RedHen CRM is one of many great stories featured in the <a href="http://www.linuxjournal.com/content/drupal-special-edition">Linux Journal's recent Drupal special addition</a>. RedHen just laid a <a href="http://drupal.org/node/1816026">beta3 release</a> and the ThinkShout team will be at the <a href="http://2012.pnwdrupalsummit.org/">Pacific Northwest Drupal Summit</a> if anyone wants to connect.</em></p>

<p>This is the 5th in a <a href="http://thinkshout.com/blog/category/redhen">series of articles exploring RedHen</a>, ThinkShout's native Drupal 7 CRM platform. ThinkShout initially designed <a href="http://drupal.org/project/redhen">RedHen CRM</a> around the complex <a href="http://en.wikipedia.org/wiki/Association_management_system">association management</a> (AMS) needs of nonprofits and trade associations. These association management requirements go well beyond the standard needs of most CRM/CMS solutions. However, in building an abstract tool with these needs at the forefront, our goal has been to future proof RedHen CRM as much as possible to ensure that its architecture can accommodate a wide variety of use cases.</p>

<p>RedHen CRM is similar to <a href="http://drupal.org/project/commerce">Drupal Commerce</a> in its modular structure. As with Drupal Commerce, the core RedHen modules that can be downloaded on the Drupal.org project page won't provide you with a working CRM right out of the box. RedHen is intended to provide developers and site builders with the building blocks for quickly creating their own CRM data models that map to their particular business requirements and workflow. Consequently, setting up a new RedHen CRM instance does require configuration.</p>

<p>In the future, ThinkShout is likely to release RedHen "Features" or "Apps" that provide prepackaged CRM solutions for different use cases. At the time of the publication of this article, we know of more than 70 RedHen CRM solutions built by other Drupal developers and site builders.</p>

<p>In addition to its association management uses, we see RedHen CRM as an ideal starting point for building custom sales pipeline management tools and project management applications, as well as Drupal integration points with 3rd-party ERP (enterprise resource planning) tools and financial accounting packages.
<!--break--></p>

<h2>Project Structure</h2>

<p>RedHen CRM consists of a core module containing shared APIs and interfaces and a collection of feature specific sub-modules, including:</p>

<ul>
<li>Contact (redhen_contact): Contact entities and APIs, along with integration with Drupal users.</li>
<li>Fields (redhen_fields): Custom field types used by RedHen entities. Currently includes a unique email field, which assigns attributes to emails, such primary, bulk, and custom labels (home, work, etc).</li>
<li>Organization (redhen_org): Organization entities and APIs.</li>
<li>Organization Group (redhen_group): Lightweight group feature which turns organizations into containers for private content with a broadcast system.</li>
<li>Relations (redhen_relation): The Relation module allows connections between contacts and organizations.</li>
<li>Note (redhen_note): Notes on contacts and organizations.</li>
<li>Engagement (redhen_engagement): Engagement scoring system and APIs. RedHen Note integration is included, as well as Rules integration for popular modules such as Comment, Registration, and Webform.</li>
<li>Registration (redhen_registration): Integration with the Entity Registration module.</li>
<li>Activity (redhen_activity): Activity logging based on the <a href="http://drupal.org/project/message">Message</a> module.</li>
</ul>

<p>We maintain other functionality that is not needed for all uses cases in separate projects in order to keep the core RedHen code base as lean as possible. The <a href="http://drupal.org/project/redhen_membership">RedHen Membership</a> system is our most widely used RedHen component with its own project name space. It handles individual and organizational membership subscriptions. As with Drupal Commerce, key sub-modules will continue to be included with the main module code base. However, we anticipate that as the RedHen CRM developer community grows, we will see more and more contributed modules that extend RedHen's core feature set.</p>

<p>The overall architecture of RedHen CRM consists of a set of minimalistic building blocks that developers and site builders can use to develop solutions tailored to specific use cases. Like Drupal Commerce, RedHen relies on Drupal distributions and installation profiles for the heavy lifting of fleshing out polished applications that serve specific needs. <a href="http://drupal.org/user/4481">Nedjo Rogers</a> of <a href="http://chocolatelilyweb.ca/">Chocolate Lily</a> has incorporated RedHen into <a href="http://openoutreach.org/">Open Outreach</a>,</p>

<blockquote>
  <p>a Drupal distribution for nonprofit &amp; grassroots groups</p>
</blockquote>

<p>and ThinkShout has released it's own demonstration of RedHen in the form of a <a href="http://drupal.org/project/redhen_demo">distribution to server the needs of a fictional pet shelter association</a>.</p>

<h2>Module Dependences</h2>

<p>RedHen has minimal dependencies on other Drupal contributed modules, striving for a balance between relying on its own code base and leveraging other code where it makes the most sense. Beyond Drupal core, RedHen CRM currently depends only on Entity API, discussed in detail below, and the <a href="http://drupal.org/project/relation">Relation</a> module for managing connections. Additionally, RedHen Activity is based on the <a href="http://drupal.org/project/message">Message module</a> which, by the way, does a great job of balancing a lean extendable base while still remaining accessible to site builders. RedHen CRM <em>supports</em> integration with popular contributed tools, like Views and Rules, but these modules are not <em>required</em>. This makes RedHen a lean and stable application platform, as it relies less on a shifting foundation of other contributed modules over which we have little to no control.</p>

<p>This centrist approach helps assure other Drupal developers that their customizations and extensions of RedHen won't break due to fragile module interdependencies. At the same time, it provides less-technical site builders with a known approach to extending RedHen CRM with standard Drupal tools, such as Views, Rules, and the Fields API.</p>

<h2>Custom Entities</h2>

<p>RedHen CRM relies on custom Drupal entity types and bundles. It leans heavily on <a href="http://drupal.org/project/entity">Entity API</a>, a wrapper around Drupal's core entity system that eases developing entities in several ways. The Entity API module:</p>

<ul>
<li>Provides classes and controllers to streamline entity creation and management. RedHen extends these base classes as needed.</li>
<li>Eases integration with key contributed modules, namely <a href="http://drupal.org/project/views">Views</a> and <a href="http://drupal.org/project/rules">Rules</a>.</li>
<li>Exposes standardized API hooks during CRUD operations providing a consistent interface for other modules to interface with your custom entities.</li>
<li>Provides hooks and data structures allowing for entities to be exported, for example, using Features or CTools. RedHen leverages this feature to make entity bundle definitions, E.g., types of contacts and organizations, exportable.</li>
</ul>

<p>On a site note, Entity API has 133,647 reported installs all on Drupal 7 and is among the top 20 modules on Drupal.org. As Drupal dependencies go, it is highly stable and reliable.</p>

<p>RedHen ships with the following entity types, each of which come bundled with core properties and can be extended with additional user-defined fields.</p>

<ul>
<li>Contacts</li>
<li>Organizations</li>
<li>Notes</li>
<li>Memberships (part of RedHen Membership)</li>
<li>Engagements</li>
</ul>

<h2>Connections</h2>

<p>A key feature of any CRM is managing connections between organizations and contacts. RedHen features a very flexible connection system built on top of the Relation module, which allows for bidirectional connections between arbitrary types of entities. These relationships themselves can have additional user-defined <em>fields</em>. RedHen ships with two types of relationships: [ital]Affiliations[ital], which are connections between an organization and a contact, and <em>Personal Connections</em>, which are connections between contacts. These relationships come bundled with status and role properties, but fields can be added that are applicable to a given relationship.</p>

<p>For example, imagine that you want to define a relationship between a contact of the type "Staff" and an organization of the type "Company." Suppose you want to include information about the position that contact has at that organization. This field value only has meaning within the context of relationship, and therefore this data is stored with the relationship rather than on the contact record or the organization record itself.</p>

<p><img src="https://dl.dropbox.com/s/6mmth05tg1t6g4h/redhen-connections.png?dl=1" alt="Connections" />
Listing of a contact's connections</p>

<h2>Playing well in the Drupal sandbox</h2>

<p>RedHen's default listings of contacts are a good start, but the fun really starts if you want to create your own custom views. The venerable Views module, a powerful graphical query builder, is the gold standard in Drupal for creating custom "lists of stuff," including RedHen entities. Much of the heavy lifting involved in Views integration is handled by Entity API, but any module implementing the Entity API interfaces still needs to clarify the data types of all entity properties and provide Views handlers for any non-standard data. For example, organization entities have a primary contact associated with them and it's up to RedHen to explain to Views that the related contact id within an organization record is actually a RedHen contact. Let's create a new View adding additional fields and relationships to our standard list of contacts:</p>

<ol>
<li>Create a new view at /admin/structure/views/add of Contacts.</li>
<li>Add relationships to Memberships and Organization affiliation.</li>
<li>Add the following fields: Contact first and last name, contact email (change the formatter to primary email), membership name, and organization name.</li>
</ol>

<p>You now have a View of all contacts that includes their membership and organization. If you set the path of the View to /redhen/contact, it will simply override the default contacts listing, or you can move it elsewhere to maintain both interfaces.</p>

<p><img src="https://www.dropbox.com/s/a4ef5l6pqlv22r3/redhen-views.png?dl=1" alt="Custom RedHen View" />
Custom contact view with an address and exposed filters.</p>

<p>Similarly, business rules can be extended using the Rules module, which provides an interface for defining logic based upon a trigger->action model. RedHen again leans on Entity API to expose RedHen entities into this model so that you can, for example, send an email to a contact when a related membership entity is updated.</p>

<p><img src="https://www.dropbox.com/s/fvr5mddv02nleef/redhen-rules.png?dl=1" alt="screenshot" />
Custom Rule that demonstrates sending an email to new contacts.</p>

<h2>Extending core functionality</h2>

<p>RedHen can also be extended and customized the old fashioned way -- by writing custom code. All of RedHen's entity types feature APIs with standard CRUD operations and wrappers around many common tasks, such as getting all related entities. In addition, RedHen can be manipulated using Drupal's hook system. Each entity can be altered using a hook implementation when it's loaded, created, updated, and deleted. Most of hooks are exposed through Entity API's inherited controller classes, but RedHen features some of its own unique hooks as explained in redhen.api.php. For example, a module can dictate whether or not a contact entity can be deleted by implementing hook_redhen_contact_can_delete():
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">mymodule_redhen_contact_can_delete</span><span style="color: #007700">(</span><span style="color: #0000BB">RedhenContact $contact</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #FF8000">// prevent the deletion of active contacts<br />&nbsp; </span><span style="color: #007700">if (</span><span style="color: #0000BB">$contact</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">redhen_state </span><span style="color: #007700">== </span><span style="color: #0000BB">REDHEN_STATE_ACTIVE</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">FALSE</span><span style="color: #007700">;<br />&nbsp; }<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>In addition, all of RedHen's main interfaces are wrapped in theme functions so they can be overridden at the theme level. For example, to alter the default list of contacts, implement theme_redhen_contact_list():
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">mytheme_redhen_contact_list</span><span style="color: #007700">(</span><span style="color: #0000BB">$variables</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">$contacts </span><span style="color: #007700">= </span><span style="color: #0000BB">$variables</span><span style="color: #007700">[</span><span style="color: #DD0000">'contacts'</span><span style="color: #007700">];<br />&nbsp; </span><span style="color: #0000BB">$header </span><span style="color: #007700">= </span><span style="color: #0000BB">$variables</span><span style="color: #007700">[</span><span style="color: #DD0000">'header'</span><span style="color: #007700">];<br />&nbsp; if (!empty(</span><span style="color: #0000BB">$contacts</span><span style="color: #007700">)) {<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$rows </span><span style="color: #007700">= array();<br />&nbsp;&nbsp;&nbsp; foreach (</span><span style="color: #0000BB">$contacts </span><span style="color: #007700">as </span><span style="color: #0000BB">$contact</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$uri </span><span style="color: #007700">= </span><span style="color: #0000BB">entity_uri</span><span style="color: #007700">(</span><span style="color: #DD0000">'redhen_contact'</span><span style="color: #007700">, </span><span style="color: #0000BB">$contact</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$actions </span><span style="color: #007700">= array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">l</span><span style="color: #007700">(</span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'edit'</span><span style="color: #007700">), </span><span style="color: #0000BB">$uri</span><span style="color: #007700">[</span><span style="color: #DD0000">'path'</span><span style="color: #007700">] . </span><span style="color: #DD0000">'/view/edit'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'query' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">drupal_get_destination</span><span style="color: #007700">())),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">l</span><span style="color: #007700">(</span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'delete'</span><span style="color: #007700">), </span><span style="color: #0000BB">$uri</span><span style="color: #007700">[</span><span style="color: #DD0000">'path'</span><span style="color: #007700">] . </span><span style="color: #DD0000">'/view/delete'</span><span style="color: #007700">, array(</span><span style="color: #DD0000">'query' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">drupal_get_destination</span><span style="color: #007700">())),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$redhen_contact_type </span><span style="color: #007700">= </span><span style="color: #0000BB">redhen_contact_type_load</span><span style="color: #007700">(</span><span style="color: #0000BB">$contact</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">type</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$rows</span><span style="color: #007700">[] = array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'data' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$redhen_contact_type</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">label</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">l</span><span style="color: #007700">(</span><span style="color: #0000BB">$contact</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">first_name</span><span style="color: #007700">, </span><span style="color: #0000BB">$uri</span><span style="color: #007700">[</span><span style="color: #DD0000">'path'</span><span style="color: #007700">]),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">l</span><span style="color: #007700">(</span><span style="color: #0000BB">$contact</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">last_name</span><span style="color: #007700">, </span><span style="color: #0000BB">$uri</span><span style="color: #007700">[</span><span style="color: #DD0000">'path'</span><span style="color: #007700">]),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">l</span><span style="color: #007700">(</span><span style="color: #0000BB">$contact</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">email</span><span style="color: #007700">, </span><span style="color: #DD0000">'mailto:' </span><span style="color: #007700">. </span><span style="color: #0000BB">$contact</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">email</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">format_date</span><span style="color: #007700">(</span><span style="color: #0000BB">$contact</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">updated</span><span style="color: #007700">, </span><span style="color: #DD0000">'short'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">implode</span><span style="color: #007700">(</span><span style="color: #DD0000">' | '</span><span style="color: #007700">, </span><span style="color: #0000BB">$actions</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$render</span><span style="color: #007700">[</span><span style="color: #DD0000">'table'</span><span style="color: #007700">] = array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#theme' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'table'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#header' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">$header</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#rows' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">$rows<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$render</span><span style="color: #007700">[</span><span style="color: #DD0000">'pager'</span><span style="color: #007700">] = array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#theme' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'pager'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp; );<br />&nbsp; }<br />&nbsp; else {<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// no results, set a message<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$render</span><span style="color: #007700">[</span><span style="color: #DD0000">'no-result'</span><span style="color: #007700">] = array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'markup'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#markup' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'Sorry, there are no contacts that match your criteria.'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp; );<br />&nbsp; }<br /><br />&nbsp; return </span><span style="color: #0000BB">render</span><span style="color: #007700">(</span><span style="color: #0000BB">$render</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>In short, using RedHen's comprehensive APIs, hooks, and theme wrappers, a developer can build a complex, elegant solution to meet nearly any use case requiring CRM functionality.</p>
</div></div></div><div class="field field-name-taxonomy-vocabulary-1 field-type-taxonomy-term-reference field-label-above"><div class="field-label">Tags:&nbsp;</div><div class="field-items"><div class="field-item even"><a href="/blog/category/redhen" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">RedHen</a></div><div class="field-item odd"><a href="/blog/category/drupal-planet" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Drupal Planet</a></div><div class="field-item even"><a href="/taxonomy/term/45" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Drupal Give</a></div></div></div>
